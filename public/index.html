<!doctype html>
<html>
<head>
    <title>STREAM</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-light bg-light">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Navbar</span>
      </div>
    </nav>

    <div>
      <div id="player-cont" class="player_block">
          <img class="pl-video" id="DisplayImg" src=""/>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
          <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-white" style="width: 380px;">
            <a href="/" class="d-flex align-items-center flex-shrink-0 p-3 link-dark text-decoration-none border-bottom">
              <svg class="bi me-2" width="30" height="24"><use xlink:href="#bootstrap"></use></svg>
              <span class="fs-5 fw-semibold">Особые места</span>
            </a>
            <div class="list-group list-group-flush border-bottom scrollarea">
              <a href="" id="point-0" class="list-group-item list-group-item-action active py-3 lh-tight" aria-current="true">
                <div class="d-flex w-100 align-items-center justify-content-between">
                  <strong class="mb-1">Лахта</strong>
                </div>
                <div class="col-10 mb-1 small">Башня Лахта центра высотой 462 метра стала самым северным небоскрёбом в мире.</div>
              </a>
              <a href="" id="point-1" class="list-group-item list-group-item-action py-3 lh-tight">
                <div class="d-flex w-100 align-items-center justify-content-between">
                  <strong class="mb-1">Газпром Арена</strong>
                </div>
                <div class="col-10 mb-1 small">В процессе строительства рабочим названием арены было «футбольный стадион...</div>
              </a>
              <a href="" id="point-2" class="list-group-item list-group-item-action py-3 lh-tight">
                <div class="d-flex w-100 align-items-center justify-content-between">
                  <strong class="mb-1">Стрелка Васильевского острова</strong>
                </div>
                <div class="col-10 mb-1 small">Мыс на восточной оконечности Васильевского острова в Санкт-Петербурге, о...</div>
              </a>
            </div>
          </div>
          <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-white" style="width: calc(95% - 380px);">
            <div id="blockinfo-0" class="content-block active">
                <img src="" class="img-fluid" alt="...">
                <h1>Лахта</h1>
                <p class="fs-5">Башня Лахта центра высотой 462 метра стала самым северным небоскрёбом в мире[12]. Является самым высоким в России и Европе и 15-м — в мире. Лахта-центр вошёл в пятёрку самых экологичных небоскрёбов мира[13]. Общая стоимость комплекса оценивалась в 120,7 млрд рублей[14].

В декабре 2020 стало известно, что «Газпром» расторг договор с генеральным подрядчиком отделочных работ внутри комплекса[12]. Планируется, что новым подрядчиком по внутренней отделке станет компания «Газпромнефть Восточно-Европейские проекты», которая занималась строительством всего комплекса[15].

В августе 2021 года ПАО «Газпром» завершило процесс перерегистрации в городе Санкт-Петербург. Новый адрес компании — по месту расположения МФК «Лахта центр».</p>
            </div>
            <div id="blockinfo-0" class="content-block">
              <img src="" class="img-fluid" alt="...">
              <h1>Газпром Арена</h1>
              <p class="fs-5">В процессе строительства рабочим названием арены было «футбольный стадион в западной части Крестовского острова». Назывались наименования «Зенит», «Зенит-Арена», «Газпром-арена», так как предполагалось, что петербургский футбольный клуб «Зенит» и его главный спонсор — компания «Газпром» будут финансово участвовать в строительстве стадиона[44][45]. Однако в итоге «Газпрому» не разрешили строить стадион, и средства были выделены из городского бюджета[30].

В мае 2009 года депутаты Законодательного собрания Санкт-Петербурга из фракции КПРФ направили губернатору города Валентине Матвиенко запрос относительно названия строящегося стадиона[46]. В июне Матвиенко в ответе на запрос пояснила, что название стадиона ещё не утверждено и будет определено топонимической комиссией[47]. Было анонсировано, что название стадиона будет выбрано в процессе широкого общественного обсуждения, к которому привлекут петербуржцев и в первую очередь болельщиков[48].

В июле 2009 года президент «Зенита» Александр Дюков объявил на встрече с болельщиками, что среди коммерческих компаний, которые хотели бы, чтобы их название вошло в название стадиона, будет проведён тендер и среди требований к участникам будет отсутствие в логотипе компании красно-белых цветов[49]. В сентябре председатель правления ОАО «Газпром» заявил журналистам, что стадион, возможно, будет называться «Газпром-арена»[50]. 17 декабря 2009 года председатель городского комитета по физической культуре и спорту Вячеслав Чазов сделал заявление, что по итогам конкурса на лучшее название стадион получит название «Газпром-арена», так как оно было поддержано большинством[51].</p>
            </div>
            <div id="blockinfo-0" class="content-block">
              <img src="" class="img-fluid" alt="...">
              <h1>Стрелка Васильевского острова</h1>
              <p class="fs-5">Мыс на восточной оконечности Васильевского острова в Санкт-Петербурге, омываемый Большой Невой и Малой Невой; один из самых известных архитектурных ансамблей города; пример гармонии архитектуры города с пейзажем берегов Невы.
Стрелка Васильевского острова относится к исторической части Санкт-Петербурга и вместе с находящимся здесь комплексом памятников входит в список объектов всемирного наследия ЮНЕСКО[1]; это один из центров притяжения туристов. Ансамбль стрелки, сложившейся в XIX веке, занимает ключевое место в панораме Санкт-Петербурга. Здесь расположены многочисленные памятники архитектуры и музеи: здание Биржи, Кунсткамера, Зоологический музей, Здание двенадцати коллегий, Здание Академии наук, Ростральные колонны. До 1885 года на Стрелке существовал Петербургский морской порт[2]. Построенные уже в XX веке пятипролётные Дворцовый и Биржевой мосты подчёркивают чёткую симметрию Стрелки Васильевского острова и её взаимосвязь с другими частями города[3].</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/js/jquery.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/gunzip.min.js"></script>
    <script type="text/javascript">
        var label_img = 1001;
        var dataID_img = 0;
        var dataLength_img = 0;
        var receivedLength_img = 0;
        var dataByte_img = new Uint8Array(0);
        var ReadyToGetFrame_img = true;

        var label_aud = 2001;
        var dataID_aud = 0;
        var dataLength_aud = 0;
        var receivedLength_aud = 0;
        var dataByte_aud = new Uint8Array(100);
        var ReadyToGetFrame_aud = true;
        var SourceSampleRate = 44100;
        var SourceChannels = 1;
        var ABuffer = new Float32Array(0);

        var socket;
        var isServer;

        var currentActiveTitle = document.getElementById("point-0");
        var currentActiveInfo = document.getElementById("blockinfo-0");

        ConnectSocketIO(false);

        function ConnectSocketIO(_regServer = false)
        {

            var socket = io.connect();

            socket.on("connect", function (data)
            {
                if(_regServer) socket.emit('RegServerId');
                isServer = _regServer;
            });

            socket.on("OnActivePoint", function (data)
            {
                currentActiveTitle.classList.remove("active");
                currentActiveInfo.classList.remove("active");
                currentActiveTitle = document.getElementById("point-" + data);
                currentActiveInfo = document.getElementById("blockinfo-" + data);
                currentActiveTitle.classList.add("active");
                currentActiveInfo.classList.add("active");
            });

            socket.on('OnReceiveData', function (data)
            {
                var _byteData = new Uint8Array(data.DataByte);
                var _label = ByteToInt32(_byteData, 0);

                if (_label == label_img) {
                    var _dataID = ByteToInt32(_byteData, 4);
                    if (_dataID != dataID_img) receivedLength_img = 0;

                    dataID_img = _dataID;
                    dataLength_img = ByteToInt32(_byteData, 8);
                    //var _offset = ByteToInt32(_byteData, 12);
                    var _GZipMode = (_byteData[16] == 1) ? true : false;

                    if (receivedLength_img == 0) dataByte_img = new Uint8Array(0);
                    receivedLength_img += _byteData.length - 18;

                    //----------------add byte----------------
                    dataByte_img = CombineInt8Array(dataByte_img, _byteData.slice(18, _byteData.length));
                    //----------------add byte----------------

                    if (ReadyToGetFrame_img)
                    {
                        if (receivedLength_img == dataLength_img) ProcessImageData(dataByte_img, _GZipMode);
                    }
                }

                if (_label == label_aud)
                {
                    var _dataID = ByteToInt32(_byteData, 4);
                    if (_dataID != dataID_aud) receivedLength_aud = 0;

                    dataID_aud = _dataID;
                    dataLength_aud = ByteToInt32(_byteData, 8);
                    //var _offset = ByteToInt32(_byteData, 12);
                    var _GZipMode = (_byteData[16] == 1) ? true : false;

                    if (receivedLength_aud == 0) dataByte_aud = new Uint8Array(0);
                    receivedLength_aud += _byteData.length - 18;
                    //----------------add byte----------------
                    dataByte_aud = CombineInt8Array(dataByte_aud, _byteData.slice(18, _byteData.length));
                    //----------------add byte----------------
                    if (ReadyToGetFrame_aud)
                    {
                        if (receivedLength_aud == dataLength_aud) ProcessAudioData(dataByte_aud, _GZipMode);
                    }
                }
            });


            var startTime = 0;
            var audioCtx = new AudioContext();

            function ProcessAudioData(_byte, _GZipMode)
            {
                ReadyToGetFrame_aud = false;

                var bytes = new Uint8Array(_byte);
                if(_GZipMode)
                {
                   var gunzip = new Zlib.Gunzip (bytes);
                   bytes = gunzip.decompress();
                }

                //read meta data
                SourceSampleRate = ByteToInt32(bytes, 0);
                SourceChannels = ByteToInt32(bytes, 4);

                //conver byte[] to float
                var BufferData = bytes.slice(8, bytes.length);
                var AudioInt16 = new Int16Array(BufferData.buffer);

                //=====================playback=====================
                if(AudioInt16.length > 0) StreamAudio(SourceChannels, AudioInt16.length, SourceSampleRate, AudioInt16);
                //=====================playback=====================

                ReadyToGetFrame_aud = true;
            }

            function StreamAudio(NUM_CHANNELS, NUM_SAMPLES, SAMPLE_RATE, AUDIO_CHUNKS)
            {
                var audioBuffer = audioCtx.createBuffer(NUM_CHANNELS, (NUM_SAMPLES / NUM_CHANNELS), SAMPLE_RATE);
                for (var channel = 0; channel < NUM_CHANNELS; channel++)
                {
                    // This gives us the actual ArrayBuffer that contains the data
                    var nowBuffering = audioBuffer.getChannelData(channel);
                    for (var i = 0; i < NUM_SAMPLES; i++)
                    {
                        var order = i * NUM_CHANNELS + channel;
                        var localSample = 1.0/32767.0;
                        localSample *= AUDIO_CHUNKS[order];
                        nowBuffering[i] = localSample;
                    }
                }

                var source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;

                source.connect(audioCtx.destination);
                source.start(startTime);

                startTime += audioBuffer.duration;
            }

            function ProcessImageData(_byte, _GZipMode)
            {
                ReadyToGetFrame_img = false;

                var binary = '';

                var bytes = new Uint8Array(_byte);
                if(_GZipMode)
                {
                    var gunzip = new Zlib.Gunzip (bytes);
                    bytes = gunzip.decompress();
                }

                //----conver byte[] to Base64 string----
                var len = bytes.byteLength;
                for (var i = 0; i < len; i++)
                {
                    binary += String.fromCharCode(bytes[i]);
                }
                //----conver byte[] to Base64 string----

                //----display image----
                var player = document.getElementById('player-cont');
                var img = document.getElementById('DisplayImg');
                img.src = 'data:image/jpeg;base64,' + btoa(binary);

                /*
                  if (data.width > player.width)
                  {
                    img.style.width = '100%';
                    img.style.height = 'auto';
                  }
                  else
                  {
                    img.style.width = 'auto';
                    img.style.height = '100%';
                  }
                */

                //img.width = data.Width;
                //img.height = data.Height;
                //----display image----

                ReadyToGetFrame_img = true;
            }

            function CombineInt8Array(a, b)
            {
                var c = new Int8Array(a.length + b.length);
                c.set(a);
                c.set(b, a.length);
                return c;
            }
            function CombineFloat32Array(a, b)
            {
                var c = new Float32Array(a.length + b.length);
                c.set(a);
                c.set(b, a.length);
                return c;
            }

            function ByteToInt32(_byte, _offset)
            {
                return (_byte[_offset] & 255) + ((_byte[_offset + 1] & 255) << 8) + ((_byte[_offset + 2] & 255) << 16) + ((_byte[_offset + 3] & 255) << 24);
                //return _byte[_offset] + _byte[_offset + 1] * 256 + _byte[_offset + 2] * 256 * 256 + _byte[_offset + 3] * 256 * 256 * 256;
            }

            socket.emit('OnRequestIDPoint', 0);
        }

        function FMEmitStringToAll(_string)
        {
            var _DataString = _string;
            var _DataByteArray = new Array(1);
            _DataByteArray[0] = 0;
            socket.emit('OnReceiveData', { EmitType: 0, DataString: _DataString, DataByte: _DataByteArray});
        }
        function FMEmitStringToServer(_string)
        {
          var _DataString = _string;
          var _DataByteArray = new Array(1);
          _DataByteArray[0] = 0;
          socket.emit('OnReceiveData', { EmitType: 1, DataString: _DataString, DataByte: _DataByteArray});
        }
        function FMEmitStringToOthers(_string)
        {
          var _DataString = _string;
          var _DataByteArray = new Array(1);
          _DataByteArray[0] = 0;
          socket.emit('OnReceiveData', { EmitType: 2, DataString: _DataString, DataByte: _DataByteArray});
        }

        function FMEmitByteToAll(_DataByteLength)
        {
            var _DataString = ' ';
            var _DataByteArray = new Array(_DataByteLength);
            for(var i = 0; i< _DataByteLength; i++) _DataByteArray[i] = 0;
            socket.emit('OnReceiveData', { EmitType: 0, DataString: _DataString, DataByte: _DataByteArray});
        }
        function FMEmitByteToServer(_DataByteLength)
        {
            var _DataString = ' ';
            var _DataByteArray = new Array(_DataByteLength);
            for(var i = 0; i< _DataByteLength; i++) _DataByteArray[i] = 0;
            socket.emit('OnReceiveData', { EmitType: 1, DataString: _DataString, DataByte: _DataByteArray});
        }
        function FMEmitByteToOthers(_DataByteLength)
        {
            var _DataString = ' ';
            var _DataByteArray = new Array(_DataByteLength);
            for(var i = 0; i< _DataByteLength; i++) _DataByteArray[i] = 0;
            socket.emit('OnReceiveData', { EmitType: 2, DataString: _DataString, DataByte: _DataByteArray});
        }

      </script>
</body>
</html>
